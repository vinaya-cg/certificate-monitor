<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ACM Sync Button</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-info { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warn { color: #dcdcaa; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ACM Sync Button Test</h1>
        <p>This page tests the ACM sync functionality locally without CloudFront caching.</p>
        
        <div class="alert alert-info">
            <strong>Test Instructions:</strong>
            <ol>
                <li>Click the "Sync from ACM v2" button below</li>
                <li>Watch the console output section for debug messages</li>
                <li>Check if the modal appears</li>
                <li>Verify the API call is made (you should see network activity)</li>
            </ol>
        </div>

        <button class="btn btn-info btn-lg" onclick="triggerACMSync()" id="acmSyncBtn">
            <i class="fas fa-cloud-download-alt"></i> Sync from ACM v2
        </button>

        <div class="console-output" id="consoleOutput">
            <div class="log-info">Console output will appear here...</div>
        </div>
    </div>

    <!-- ACM Sync Modal -->
    <div id="acmSyncModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('acmSyncModal')">&times;</span>
            <h3>ACM Certificate Sync</h3>
            
            <!-- Progress View -->
            <div id="acmSyncProgress">
                <div style="text-align: center; padding: 30px 0;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p style="margin-top: 20px; font-size: 16px;">Synchronizing certificates from AWS ACM...</p>
                    <p style="color: #666; font-size: 14px;">This may take a few moments</p>
                </div>
            </div>
            
            <!-- Results View -->
            <div id="acmSyncResults" style="display: none;">
                <div style="padding: 20px 0;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #1976d2;" id="acmSyncFound">0</div>
                            <div style="color: #666; margin-top: 5px;">Certificates Found</div>
                        </div>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #388e3c;" id="acmSyncAdded">0</div>
                            <div style="color: #666; margin-top: 5px;">Newly Added</div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #f57c00;" id="acmSyncUpdated">0</div>
                            <div style="color: #666; margin-top: 5px;">Updated</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #d32f2f;" id="acmSyncErrors">0</div>
                            <div style="color: #666; margin-top: 5px;">Errors</div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="closeModal('acmSyncModal'); loadCertificates();">
                            Refresh Dashboard
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal('acmSyncModal')" style="margin-left: 10px;">
                            Close
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Error View -->
            <div id="acmSyncError" style="display: none;">
                <div class="alert alert-danger">
                    <h5>Sync Failed</h5>
                    <p id="acmSyncErrorMessage"></p>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-secondary" onclick="closeModal('acmSyncModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Override console.log to display in the page
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogEntry(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogEntry('WARN: ' + args.join(' '), 'warn');
        };

        // Get auth headers from Cognito
        function getAuthHeaders() {
            console.log('getAuthHeaders called');
            const idToken = localStorage.getItem('idToken');
            if (!idToken) {
                console.error('No ID token found in localStorage');
                return {};
            }
            console.log('ID token found, length:', idToken.length);
            return {
                'Authorization': idToken,
                'Content-Type': 'application/json'
            };
        }

        // Mock API URL - replace with your actual API Gateway URL
        const API_URL = 'https://8clm33qmf9.execute-api.eu-west-1.amazonaws.com/dev-secure';

        async function triggerACMSync() {
            console.log('ACM Sync button clicked');
            
            try {
                // Confirm action
                const confirmed = confirm('Synchronize certificates from AWS Certificate Manager?\n\nThis will scan ACM in your AWS account and update the dashboard with the latest certificate information.');
                console.log('User confirmed:', confirmed);
                
                if (!confirmed) {
                    console.log('User cancelled sync');
                    return;
                }

                console.log('Opening modal...');
                
                // Verify modal elements exist
                const modal = document.getElementById('acmSyncModal');
                const progressDiv = document.getElementById('acmSyncProgress');
                const resultsDiv = document.getElementById('acmSyncResults');
                const errorDiv = document.getElementById('acmSyncError');
                
                console.log('Modal elements found:', {
                    modal: !!modal,
                    progress: !!progressDiv,
                    results: !!resultsDiv,
                    error: !!errorDiv
                });
                
                if (!modal) {
                    console.error('Modal not found!');
                    alert('Error: Modal element not found');
                    return;
                }
                
                // Show modal with progress
                modal.style.display = 'block';
                if (progressDiv) progressDiv.style.display = 'block';
                if (resultsDiv) resultsDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
                
                console.log('Modal displayed');

                // Get auth headers
                console.log('Getting auth headers...');
                const headers = getAuthHeaders();
                console.log('Headers prepared:', Object.keys(headers));
                
                // Call API to trigger sync
                console.log('Calling API:', API_URL + '/sync-acm');
                const response = await fetch(API_URL + '/sync-acm', {
                    method: 'POST',
                    headers: headers
                });
                
                console.log('API response status:', response.status);
                console.log('API response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error(`Failed to start ACM sync: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('API response data:', JSON.stringify(data, null, 2));
                
                // Start polling for results
                console.log('Starting polling for results...');
                await pollACMSyncStatus();
                
            } catch (error) {
                console.error('Error in triggerACMSync:', error);
                console.error('Error stack:', error.stack);
                
                const errorDiv = document.getElementById('acmSyncError');
                const errorMsg = document.getElementById('acmSyncErrorMessage');
                const progressDiv = document.getElementById('acmSyncProgress');
                
                if (progressDiv) progressDiv.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
                if (errorMsg) errorMsg.textContent = error.message;
            }
        }

        async function pollACMSyncStatus() {
            console.log('pollACMSyncStatus started');
            const maxAttempts = 60;
            const pollInterval = 1000; // 1 second
            
            for (let attempts = 1; attempts <= maxAttempts; attempts++) {
                console.log(`Polling attempt ${attempts}/${maxAttempts}`);
                
                try {
                    // Get recent certificates (synced in last 2 minutes)
                    const headers = getAuthHeaders();
                    const response = await fetch(API_URL + '/certificates', {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to fetch certificates:', response.status);
                        continue;
                    }
                    
                    const data = await response.json();
                    console.log(`Received ${data.certificates?.length || 0} total certificates`);
                    
                    // Filter for recently synced certificates
                    const twoMinutesAgo = Date.now() - (2 * 60 * 1000);
                    const recentlySynced = data.certificates.filter(cert => {
                        if (!cert.LastSyncedFromACM) return false;
                        const syncTime = new Date(cert.LastSyncedFromACM).getTime();
                        return syncTime > twoMinutesAgo;
                    });
                    
                    const currentCount = recentlySynced.length;
                    console.log(`Found ${currentCount} recently synced certificates`);
                    
                    if (currentCount > 0) {
                        // Calculate stats
                        const newCerts = recentlySynced.filter(c => c.Version === 1).length;
                        const updatedCerts = currentCount - newCerts;
                        
                        console.log('Sync complete! Stats:', {
                            found: currentCount,
                            added: newCerts,
                            updated: updatedCerts,
                            errors: 0
                        });
                        
                        showACMSyncResults(currentCount, newCerts, updatedCerts, 0);
                        return;
                    }
                    
                } catch (error) {
                    console.error(`Error in polling attempt ${attempts}:`, error);
                }
                
                // Wait before next attempt
                await new Promise(resolve => setTimeout(resolve, pollInterval));
            }
            
            // Timeout - show what we have
            console.warn('Polling timeout - showing default results');
            showACMSyncResults(0, 0, 0, 0);
        }

        function showACMSyncResults(found, added, updated, errors) {
            console.log('showACMSyncResults called:', {found, added, updated, errors});
            
            const progressDiv = document.getElementById('acmSyncProgress');
            const errorDiv = document.getElementById('acmSyncError');
            const resultsDiv = document.getElementById('acmSyncResults');
            
            if (progressDiv) progressDiv.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'none';
            if (resultsDiv) resultsDiv.style.display = 'block';
            
            const foundEl = document.getElementById('acmSyncFound');
            const addedEl = document.getElementById('acmSyncAdded');
            const updatedEl = document.getElementById('acmSyncUpdated');
            const errorsEl = document.getElementById('acmSyncErrors');
            
            if (foundEl) foundEl.textContent = found;
            if (addedEl) addedEl.textContent = added;
            if (updatedEl) updatedEl.textContent = updated;
            if (errorsEl) errorsEl.textContent = errors;
            
            console.log('Results displayed');
        }

        function closeModal(modalId) {
            console.log('Closing modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function loadCertificates() {
            console.log('loadCertificates called (mock)');
            alert('This would reload the certificates table');
        }

        console.log('Test page loaded successfully!');
        console.log('API_URL:', API_URL);
        console.log('Ready to test ACM sync button');
    </script>
</body>
</html>
