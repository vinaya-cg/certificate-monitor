{
  "schemaVersion": "2.2",
  "description": "Fetch certificates from Linux servers (system and custom certificate paths)",
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "fetchCertificates",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "",
          "# Certificate paths to scan",
          "CERT_PATHS=(",
          "  \"/etc/ssl/certs\"",
          "  \"/etc/pki/tls/certs\"",
          "  \"/etc/pki/ca-trust/extracted/pem\"",
          "  \"/usr/local/share/ca-certificates\"",
          "  \"/opt/certificates\"",
          "  \"/var/certificates\"",
          ")",
          "",
          "# Output array for JSON",
          "echo '['",
          "first=true",
          "",
          "# Function to parse certificate",
          "parse_certificate() {",
          "    local cert_file=\"$1\"",
          "    ",
          "    # Check if file exists and is readable",
          "    if [ ! -f \"$cert_file\" ] || [ ! -r \"$cert_file\" ]; then",
          "        return",
          "    fi",
          "    ",
          "    # Check if file contains certificate",
          "    if ! grep -q 'BEGIN CERTIFICATE' \"$cert_file\" 2>/dev/null; then",
          "        return",
          "    fi",
          "    ",
          "    # Extract certificate information using openssl",
          "    subject=$(openssl x509 -in \"$cert_file\" -noout -subject 2>/dev/null | sed 's/subject=//')",
          "    issuer=$(openssl x509 -in \"$cert_file\" -noout -issuer 2>/dev/null | sed 's/issuer=//')",
          "    notAfter=$(openssl x509 -in \"$cert_file\" -noout -enddate 2>/dev/null | sed 's/notAfter=//')",
          "    notBefore=$(openssl x509 -in \"$cert_file\" -noout -startdate 2>/dev/null | sed 's/notBefore=//')",
          "    fingerprint=$(openssl x509 -in \"$cert_file\" -noout -fingerprint -sha256 2>/dev/null | sed 's/SHA256 Fingerprint=//')",
          "    serial=$(openssl x509 -in \"$cert_file\" -noout -serial 2>/dev/null | sed 's/serial=//')",
          "    ",
          "    # Only output if we successfully extracted data",
          "    if [ -n \"$subject\" ] && [ -n \"$notAfter\" ] && [ -n \"$fingerprint\" ]; then",
          "        if [ \"$first\" = false ]; then",
          "            echo ','",
          "        fi",
          "        first=false",
          "        ",
          "        # Escape special characters for JSON",
          "        subject_escaped=$(echo \"$subject\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        issuer_escaped=$(echo \"$issuer\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        notAfter_escaped=$(echo \"$notAfter\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        notBefore_escaped=$(echo \"$notBefore\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        fingerprint_escaped=$(echo \"$fingerprint\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        serial_escaped=$(echo \"$serial\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        path_escaped=$(echo \"$cert_file\" | sed 's/\\\\/\\\\\\\\/g; s/\"/\\\\\"/g')",
          "        ",
          "        echo -n \"{\"",
          "        echo -n \"\\\"subject\\\":\\\"$subject_escaped\\\",\"",
          "        echo -n \"\\\"issuer\\\":\\\"$issuer_escaped\\\",\"",
          "        echo -n \"\\\"notAfter\\\":\\\"$notAfter_escaped\\\",\"",
          "        echo -n \"\\\"notBefore\\\":\\\"$notBefore_escaped\\\",\"",
          "        echo -n \"\\\"fingerprint\\\":\\\"$fingerprint_escaped\\\",\"",
          "        echo -n \"\\\"serial\\\":\\\"$serial_escaped\\\",\"",
          "        echo -n \"\\\"path\\\":\\\"$path_escaped\\\"\"",
          "        echo -n \"}\"",
          "    fi",
          "}",
          "",
          "# Scan all certificate paths",
          "for cert_path in \"${CERT_PATHS[@]}\"; do",
          "    if [ -d \"$cert_path\" ]; then",
          "        echo \"# Scanning: $cert_path\" >&2",
          "        ",
          "        # Find all certificate files",
          "        find \"$cert_path\" -maxdepth 3 -type f \\( -name '*.crt' -o -name '*.pem' -o -name '*.cer' -o -name '*.cert' \\) 2>/dev/null | while read cert_file; do",
          "            parse_certificate \"$cert_file\"",
          "        done",
          "    fi",
          "done",
          "",
          "echo ']'",
          "",
          "echo \"# Certificate scan completed.\" >&2"
        ]
      }
    }
  ]
}
