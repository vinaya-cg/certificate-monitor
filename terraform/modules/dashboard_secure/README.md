# Dashboard Secure Module

This module uploads dashboard files to S3 with dynamic configuration injection, enabling 100% portable deployments.

## Purpose

Automatically generates and uploads dashboard files (HTML, JavaScript, images) to S3 with environment-specific configuration injected at deployment time. This eliminates hardcoded values and enables the same codebase to work in any AWS account/region.

## Resources Created

### S3 Objects (Dashboard Files)

#### HTML Files
- **`index.html`** - Main dashboard page
- **`login.html`** - Login page with password change modal
- **`error.html`** - Error page for 404/403

#### JavaScript Files (Auto-Generated with Configuration)
- **`dashboard.js`** - Dashboard logic with API Gateway URL injected
- **`auth.js`** - Authentication utilities with Cognito config injected
- **`auth-cognito.js`** - Cognito SDK integration with complete config injected

#### Image Files
- **`images/sogeti-logo.png`** - Sogeti logo
- **`images/postnl-logo.png`** - PostNL logo

## Template Variables Injected

### dashboard.js
```javascript
const API_GATEWAY_URL = '${var.api_gateway_url}';
```

### auth.js
```javascript
const COGNITO_CONFIG = {
    userPoolId: '${var.cognito_user_pool_id}',
    clientId: '${var.cognito_client_id}',
    region: '${var.aws_region}'
};
```

### auth-cognito.js
```javascript
const COGNITO_CONFIG = {
    userPoolId: '${var.cognito_user_pool_id}',
    clientId: '${var.cognito_client_id}',
    region: '${var.aws_region}',
    identityPoolId: '${var.cognito_identity_pool_id}',
    domain: '${var.cognito_domain}'
};
```

## Inputs

| Variable | Type | Description | Required |
|----------|------|-------------|----------|
| `bucket_name` | `string` | S3 bucket name for dashboard files | Yes |
| `api_gateway_url` | `string` | API Gateway URL for backend API | Yes |
| `cognito_user_pool_id` | `string` | Cognito User Pool ID | Yes |
| `cognito_client_id` | `string` | Cognito Client ID | Yes |
| `cognito_identity_pool_id` | `string` | Cognito Identity Pool ID | Yes |
| `cognito_domain` | `string` | Cognito hosted UI domain | Yes |
| `aws_region` | `string` | AWS region | Yes |

## Outputs

None (files uploaded directly to S3)

## Example Usage

```hcl
module "dashboard_secure" {
  source = "../../modules/dashboard_secure"

  bucket_name               = module.storage_secure.dashboard_bucket_name
  api_gateway_url           = module.api_gateway.api_gateway_url
  cognito_user_pool_id      = module.cognito.user_pool_id
  cognito_client_id         = module.cognito.client_id
  cognito_identity_pool_id  = module.cognito.identity_pool_id
  cognito_domain            = module.cognito.domain_url
  aws_region                = var.aws_region
}
```

## How It Works

### Static Files (HTML, Images)
Uploaded as-is from local filesystem:
```hcl
resource "aws_s3_object" "index_html" {
  bucket       = var.bucket_name
  key          = "index.html"
  source       = "${path.module}/../../../dashboard/index.html"
  content_type = "text/html"
  etag         = filemd5("${path.module}/../../../dashboard/index.html")
}
```

### Templated Files (JavaScript)
Generated dynamically with variable injection:
```hcl
locals {
  dashboard_js_content = <<-EOT
// API Configuration - Auto-generated by Terraform
const API_GATEWAY_URL = '${var.api_gateway_url}';

// ... rest of dashboard.js code ...
EOT
}

resource "aws_s3_object" "dashboard_js" {
  bucket       = var.bucket_name
  key          = "dashboard.js"
  content      = local.dashboard_js_content
  content_type = "application/javascript"
  etag         = md5(local.dashboard_js_content)
  cache_control = "no-cache, no-store, must-revalidate"
}
```

## Cache Control Settings

| File Type | Cache Control | Reason |
|-----------|---------------|--------|
| HTML | `no-cache, no-store, must-revalidate` | Always fetch latest version |
| JS (config) | `no-cache, no-store, must-revalidate` | Configuration may change |
| Images | `public, max-age=31536000` | Static assets, cache 1 year |

## Portability Features

This module is **critical for portability** because:

1. **No Hardcoded Values**: All AWS resource identifiers injected at deployment time
2. **Environment-Agnostic**: Same source files work in dev, staging, prod
3. **Region-Agnostic**: Works in any AWS region without modification
4. **Account-Agnostic**: Works in any AWS account without modification

### Before (Manual Upload - NOT Portable)
```javascript
// auth-cognito.js - HARDCODED VALUES ❌
const COGNITO_CONFIG = {
    userPoolId: 'eu-west-1_13fKTZw4o',  // Only works in one environment
    clientId: '2ggi07dd8s63p3469j59t82p0o',
    region: 'eu-west-1',
    // ...
};
```

### After (Terraform Templating - 100% Portable)
```javascript
// auth-cognito.js - DYNAMIC VALUES ✅
const COGNITO_CONFIG = {
    userPoolId: '${var.cognito_user_pool_id}',  // Works everywhere
    clientId: '${var.cognito_client_id}',
    region: '${var.aws_region}',
    // ...
};
```

## File Structure

```
dashboard_secure/
├── main.tf           # S3 object resources and template logic
├── variables.tf      # Input variables
└── README.md         # This file

Source Files (referenced):
../../../dashboard/
├── index.html
├── login.html
├── error.html
├── dashboard.js      # Template base
├── auth.js           # Template base
├── auth-cognito.js   # Template base
└── images/
    ├── sogeti-logo.png
    └── postnl-logo.png
```

## Dashboard Files Explained

### index.html
- **Purpose**: Main dashboard interface
- **Features**:
  - Certificate table with search, filter, sort
  - Add/edit/delete certificate modals
  - Excel file upload
  - Responsive design
- **Authentication**: Requires valid Cognito session (checked by auth.js)
- **API Calls**: Uses fetch() with Authorization header to API Gateway

### login.html
- **Purpose**: User authentication interface
- **Features**:
  - Email/password login form
  - Password change modal (for FORCE_CHANGE_PASSWORD status)
  - Real-time password validation
  - Remember me checkbox
- **Authentication Flow**:
  1. User enters credentials
  2. Calls auth-cognito.js → signIn()
  3. If temporary password → show change password modal
  4. If success → redirect to index.html
  5. Store tokens in sessionStorage

### error.html
- **Purpose**: User-friendly error page
- **Triggered**: CloudFront 404/403 errors
- **Features**:
  - Error message display
  - "Return to Dashboard" link
  - Branding consistent with main dashboard

### dashboard.js
- **Purpose**: Dashboard business logic
- **Functions**:
  - `loadCertificates()` - Fetch and display certificates
  - `addCertificate()` - Create new certificate
  - `updateCertificate()` - Update existing certificate
  - `deleteCertificate()` - Delete certificate
  - `uploadExcel()` - Bulk import from Excel
  - `filterCertificates()` - Client-side filtering
  - `searchCertificates()` - Client-side search
- **API Integration**: Uses API_GATEWAY_URL constant

### auth.js
- **Purpose**: Authentication utilities
- **Functions**:
  - `isAuthenticated()` - Check if user logged in
  - `getIdToken()` - Get JWT token for API calls
  - `signOut()` - Logout user
  - `protectPage()` - Redirect to login if not authenticated

### auth-cognito.js
- **Purpose**: Cognito SDK integration
- **Functions**:
  - `signIn(username, password)` - Authenticate user
  - `changePassword(oldPassword, newPassword)` - Change password
  - `getCurrentUser()` - Get current user info
  - `hasPermission(action)` - Check RBAC permissions
- **Configuration**: Uses COGNITO_CONFIG constant with all Cognito details

## Updating Dashboard Files

### Update Static Content (HTML, Images)
1. Edit file in `dashboard/` directory
2. Run `terraform apply`
3. Terraform detects change via `etag = filemd5(...)`
4. Uploads new version to S3
5. Invalidate CloudFront cache:
   ```bash
   aws cloudfront create-invalidation --distribution-id E2CPB8IUR80ZRD --paths "/*"
   ```

### Update Templated JavaScript
1. Edit template in `modules/dashboard_secure/main.tf` (in `locals` block)
2. Run `terraform apply`
3. Terraform detects change via `etag = md5(local.xxx_content)`
4. Uploads new version to S3
5. Invalidate CloudFront cache

## Security Considerations

### No Secrets in JavaScript
- **Never**: Store AWS credentials, API keys, secrets in JavaScript files
- **Why**: All JavaScript files are publicly accessible via CloudFront
- **Safe**: User Pool ID, Client ID, Region (these are public identifiers)
- **Unsafe**: Secret keys, database credentials, private keys

### Authentication Flow
```
User → CloudFront → S3 (download dashboard.js)
     ↓
User enters credentials
     ↓
dashboard.js → Cognito (authenticate)
     ↓
Cognito returns JWT tokens
     ↓
dashboard.js stores tokens in sessionStorage
     ↓
API calls include JWT in Authorization header
     ↓
API Gateway validates JWT with Cognito
     ↓
Lambda receives authenticated user context
```

## Troubleshooting

### Issue: Dashboard shows old configuration
**Cause**: CloudFront cache not invalidated  
**Solution**:
```bash
aws cloudfront create-invalidation --distribution-id E2CPB8IUR80ZRD --paths "/dashboard.js" "/auth-cognito.js" "/auth.js"
```

### Issue: "API_GATEWAY_URL is not defined"
**Cause**: dashboard.js not templated correctly  
**Solution**: Check Terraform logs, verify `api_gateway_url` variable passed correctly

### Issue: "Cannot read property 'userPoolId' of undefined"
**Cause**: COGNITO_CONFIG not injected  
**Solution**: Check auth-cognito.js uploaded correctly, verify all Cognito variables passed

### Issue: Files not updating after terraform apply
**Cause**: ETag unchanged (file content identical)  
**Solution**: Modify file content or force re-upload by tainting resource:
```bash
terraform taint 'module.dashboard_secure.aws_s3_object.dashboard_js'
terraform apply
```

## Best Practices

1. **Version Control**: Keep source files in `dashboard/` directory under version control
2. **Templating**: Add new configuration to `locals` blocks, not source files
3. **Cache Invalidation**: Always invalidate CloudFront after updates
4. **Testing**: Test changes in dev environment before production
5. **Secrets**: Never put secrets in JavaScript files (use environment variables in Lambda instead)
6. **Documentation**: Document any template variables added

## Cost

**S3 Storage**: ~$0.023 per GB/month  
**S3 Requests**: ~$0.0004 per 1,000 requests  

Total for dashboard files (~5 MB): **~$0.01/month** (negligible)

## Dependencies

- **S3 Bucket**: Requires dashboard bucket from storage_secure module
- **API Gateway**: Requires API URL from api_gateway module
- **Cognito**: Requires all Cognito identifiers from cognito module

## Related Modules

- **Storage Secure**: Creates S3 bucket for dashboard files
- **CloudFront**: Serves dashboard files over HTTPS
- **Cognito**: Provides authentication configuration
- **API Gateway**: Provides REST API endpoint

## References

- [Terraform Heredoc Syntax](https://www.terraform.io/language/expressions/strings#heredoc-strings)
- [S3 Object Resource](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_object)
- [Terraform Templates](https://www.terraform.io/language/functions/templatefile)
