<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Step-by-Step Diagnostic</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        .step { margin: 10px 0; padding: 10px; background: #2d2d2d; border-left: 4px solid #666; }
        .pass { border-left-color: #00ff00; }
        .fail { border-left-color: #ff0000; color: #ff6666; }
        .pending { border-left-color: #ffff00; color: #ffff99; }
        pre { background: #000; padding: 10px; overflow-x: auto; margin: 5px 0; }
        button { background: #007acc; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ðŸ”¬ Certificate Dashboard - Step-by-Step Diagnostic</h1>
    
    <div id="step1" class="step pending">
        <strong>Step 1:</strong> Testing basic fetch capability...
    </div>
    
    <div id="step2" class="step pending">
        <strong>Step 2:</strong> Testing API endpoint accessibility...
    </div>
    
    <div id="step3" class="step pending">
        <strong>Step 3:</strong> Checking CORS headers...
    </div>
    
    <div id="step4" class="step pending">
        <strong>Step 4:</strong> Parsing JSON response...
    </div>
    
    <div id="step5" class="step pending">
        <strong>Step 5:</strong> Validating data structure...
    </div>
    
    <div id="step6" class="step pending">
        <strong>Step 6:</strong> Creating table HTML...
    </div>
    
    <div id="results"></div>
    
    <button onclick="runAllTests()">Run All Tests Again</button>
    
    <script>
        const API_URL = 'https://rwqmbee3uvlzkogzhxiwg3fvzi0dmgmx.lambda-url.eu-west-1.on.aws/';
        let testData = null;
        
        function updateStep(stepNum, status, message, data = null) {
            const el = document.getElementById('step' + stepNum);
            el.className = 'step ' + status;
            el.innerHTML = `<strong>Step ${stepNum}:</strong> ${message}`;
            if (data) {
                el.innerHTML += `<pre>${data}</pre>`;
            }
        }
        
        async function step1_testFetch() {
            try {
                updateStep(1, 'pending', 'Testing if fetch API is available...');
                
                if (typeof fetch === 'undefined') {
                    updateStep(1, 'fail', 'FAILED: fetch API not available in this browser!');
                    return false;
                }
                
                updateStep(1, 'pass', 'PASS: fetch API is available âœ“');
                return true;
                
            } catch (error) {
                updateStep(1, 'fail', 'ERROR: ' + error.message);
                return false;
            }
        }
        
        async function step2_testAPIConnection() {
            try {
                updateStep(2, 'pending', 'Connecting to API endpoint...');
                
                const response = await fetch(API_URL);
                
                updateStep(2, 'pass', `PASS: API returned status ${response.status} âœ“`, 
                    `URL: ${API_URL}\nStatus: ${response.status} ${response.statusText}`);
                
                return response;
                
            } catch (error) {
                updateStep(2, 'fail', 'FAILED: Could not connect to API', 
                    `Error: ${error.message}\nThis could be a network or CORS issue.`);
                return null;
            }
        }
        
        async function step3_checkCORS(response) {
            try {
                updateStep(3, 'pending', 'Checking CORS headers...');
                
                if (!response) {
                    updateStep(3, 'fail', 'SKIPPED: No response from previous step');
                    return false;
                }
                
                const corsOrigin = response.headers.get('Access-Control-Allow-Origin');
                const corsMethod = response.headers.get('Access-Control-Allow-Methods');
                
                const details = `Access-Control-Allow-Origin: ${corsOrigin || 'MISSING!'}\nAccess-Control-Allow-Methods: ${corsMethod || 'MISSING!'}`;
                
                if (!corsOrigin) {
                    updateStep(3, 'fail', 'FAILED: CORS headers missing!', details);
                    return false;
                }
                
                updateStep(3, 'pass', 'PASS: CORS headers present âœ“', details);
                return true;
                
            } catch (error) {
                updateStep(3, 'fail', 'ERROR: ' + error.message);
                return false;
            }
        }
        
        async function step4_parseJSON(response) {
            try {
                updateStep(4, 'pending', 'Parsing JSON response...');
                
                if (!response) {
                    updateStep(4, 'fail', 'SKIPPED: No response from previous step');
                    return null;
                }
                
                const data = await response.json();
                testData = data;
                
                updateStep(4, 'pass', 'PASS: JSON parsed successfully âœ“', 
                    `Response keys: ${Object.keys(data).join(', ')}`);
                
                return data;
                
            } catch (error) {
                updateStep(4, 'fail', 'FAILED: Could not parse JSON', 
                    `Error: ${error.message}\nResponse may not be valid JSON.`);
                return null;
            }
        }
        
        async function step5_validateData(data) {
            try {
                updateStep(5, 'pending', 'Validating data structure...');
                
                if (!data) {
                    updateStep(5, 'fail', 'SKIPPED: No data from previous step');
                    return false;
                }
                
                const issues = [];
                
                if (!data.hasOwnProperty('count')) issues.push('Missing "count" property');
                if (!data.hasOwnProperty('certificates')) issues.push('Missing "certificates" property');
                if (!Array.isArray(data.certificates)) issues.push('"certificates" is not an array');
                
                if (issues.length > 0) {
                    updateStep(5, 'fail', 'FAILED: Invalid data structure', 
                        `Issues:\n${issues.join('\n')}\n\nActual data:\n${JSON.stringify(data, null, 2).substring(0, 500)}`);
                    return false;
                }
                
                const details = `Count: ${data.count}\nCertificates array length: ${data.certificates.length}\nFirst cert name: ${data.certificates[0]?.CertificateName || 'N/A'}`;
                updateStep(5, 'pass', 'PASS: Data structure is valid âœ“', details);
                
                return true;
                
            } catch (error) {
                updateStep(5, 'fail', 'ERROR: ' + error.message);
                return false;
            }
        }
        
        async function step6_createTable(data) {
            try {
                updateStep(6, 'pending', 'Creating table HTML...');
                
                if (!data || !data.certificates) {
                    updateStep(6, 'fail', 'SKIPPED: No valid data');
                    return;
                }
                
                let tableHTML = '<table border="1" style="width:100%; border-collapse: collapse; margin-top: 20px;">';
                tableHTML += '<tr style="background: #333;">';
                tableHTML += '<th>Name</th><th>Environment</th><th>Status</th><th>Expiry</th>';
                tableHTML += '</tr>';
                
                const sample = data.certificates.slice(0, 5);
                sample.forEach(cert => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${cert.CertificateName || 'N/A'}</td>`;
                    tableHTML += `<td>${cert.Environment || 'N/A'}</td>`;
                    tableHTML += `<td>${cert.Status || 'N/A'}</td>`;
                    tableHTML += `<td>${cert.ExpiryDate || 'N/A'}</td>`;
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</table>';
                
                document.getElementById('results').innerHTML = `
                    <h2>âœ… SUCCESS! All Tests Passed</h2>
                    <p>Total certificates: ${data.count}</p>
                    <p>Showing first 5 certificates:</p>
                    ${tableHTML}
                `;
                
                updateStep(6, 'pass', `PASS: Created table with ${sample.length} rows âœ“`);
                
            } catch (error) {
                updateStep(6, 'fail', 'ERROR: ' + error.message, error.stack);
            }
        }
        
        async function runAllTests() {
            console.log('Starting diagnostic tests...');
            
            // Clear results
            document.getElementById('results').innerHTML = '';
            
            // Step 1
            const fetchOK = await step1_testFetch();
            if (!fetchOK) return;
            
            // Step 2
            const response = await step2_testAPIConnection();
            if (!response) return;
            
            // Step 3
            const corsOK = await step3_checkCORS(response);
            // Continue even if CORS check fails (might still work)
            
            // Step 4
            const data = await step4_parseJSON(response);
            if (!data) return;
            
            // Step 5
            const validData = await step5_validateData(data);
            if (!validData) return;
            
            // Step 6
            await step6_createTable(data);
            
            console.log('All tests completed!');
        }
        
        // Run tests on page load
        window.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>
